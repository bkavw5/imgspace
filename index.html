<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>imgUP — Upload Ảnh</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --muted: #94a3b8;
      --accent: #06b6d4;
      --success: #10b981;
      --error: #ef4444;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: linear-gradient(180deg, #071024, #081426);
      color: #e6eef6;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      padding: 20px;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      line-height: 1.5;
    }
    
    .card {
      width: 100%;
      max-width: 1000px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
    }
    
    h1 {
      margin: 0 0 12px 0;
      font-size: 28px;
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .section-title {
      margin: 20px 0 12px 0;
      font-size: 18px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-title svg {
      width: 20px;
      height: 20px;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 16px;
    }
    
    input[type="text"] {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px dashed rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      color: inherit;
      font-size: 14px;
      transition: all 0.2s;
      flex: 1;
      min-width: 0;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }
    
    button {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    button svg {
      width: 16px;
      height: 16px;
    }
    
    .btn {
      background: var(--accent);
      color: #052024;
    }
    
    .btn:hover:not(:disabled) {
      background: #08d1f2;
      transform: translateY(-1px);
    }
    
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--muted);
    }
    
    .btn-ghost:hover:not(:disabled) {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.12);
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
    }
    
    .checkbox-container input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }
    
    .drop {
      border: 2px dashed rgba(255,255,255,0.06);
      padding: 30px 24px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 16px;
    }
    
    .drop:hover {
      border-color: var(--accent);
      background: rgba(6, 182, 212, 0.05);
    }
    
    .drop.dragover {
      border-color: var(--accent);
      background: rgba(6, 182, 212, 0.1);
    }
    
    .thumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
    }
    
    .thumb {
      width: 150px;
      background: rgba(255,255,255,0.02);
      padding: 10px;
      border-radius: 10px;
      position: relative;
    }
    
    .thumb img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .thumb-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 5px;
    }
    
    .thumb-actions button {
      padding: 4px;
      background: rgba(0,0,0,0.6);
      border-radius: 4px;
      width: 24px;
      height: 24px;
    }
    
    .thumb-info {
      margin-top: 8px;
      font-size: 12px;
    }
    
    .progress {
      height: 6px;
      background: rgba(255,255,255,0.04);
      border-radius: 99px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .progress-bar {
      display: block;
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
      transition: width 0.3s;
    }
    
    .upload-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      align-items: center;
    }
    
    .status {
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    
    .status.success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      display: block;
    }
    
    .status.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
      display: block;
    }
    
    .url-upload {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .url-upload input {
      flex: 1;
      min-width: 200px;
    }
    
    .history {
      margin-top: 24px;
    }
    
    .history-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    
    .history-item {
      background: rgba(255,255,255,0.02);
      padding: 12px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .history-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .history-info {
      font-size: 13px;
    }
    
    .history-url {
      display: flex;
      gap: 8px;
    }
    
    .history-url input {
      flex: 1;
      font-size: 12px;
      padding: 6px 10px;
    }
    
    .history-actions {
      display: flex;
      gap: 8px;
    }
    
    .history-actions button {
      flex: 1;
      font-size: 12px;
      padding: 6px 10px;
    }
    
    .empty-history {
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }
    
    .clear-history {
      margin-top: 16px;
      text-align: right;
    }
    
    hr {
      border: none;
      height: 1px;
      background: rgba(255,255,255,0.06);
      margin: 20px 0;
    }
    
    @media (max-width: 768px) {
      .card {
        padding: 16px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .checkbox-container {
        margin-left: 0;
        margin-top: 10px;
      }
      
      .history-items {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>imgUP — Upload Ảnh</h1>
    
    <div class="controls">
      <input id="apiToken" type="text" placeholder="Bearer token" />
      <button id="saveToken" class="btn-ghost">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Lưu
      </button>
      
      <div class="checkbox-container">
        <input id="preserve" type="checkbox" />
        <label for="preserve" class="muted">Giữ định dạng gốc</label>
      </div>
      
      <button id="pickFiles" class="btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        Chọn ảnh
      </button>
    </div>

    <div id="drop" class="drop">
      <div style="font-weight:600; margin-bottom:8px">Kéo & thả ảnh vào đây</div>
      <div class="muted">Hỗ trợ JPG, PNG, GIF, WebP — Tối đa 15MB</div>
    </div>

    <input id="fileInput" type="file" accept=".jpg,.jpeg,.png,.gif,.webp" multiple style="display:none" />
    <div id="thumbs" class="thumbs"></div>

    <div class="upload-actions">
      <button id="uploadBtn" class="btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        Upload file(s)
      </button>
      <button id="clearBtn" class="btn-ghost">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        Xóa
      </button>
    </div>

    <div id="status" class="status"></div>

    <hr>

    <div class="section-title">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
      </svg>
      Upload từ URL
    </div>
    
    <div class="url-upload">
      <input id="urlInput" type="text" placeholder="https://example.com/image.jpg" />
      <button id="uploadUrlBtn" class="btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        Upload
      </button>
    </div>

    <hr>

    <div class="section-title">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
      </svg>
      Lịch sử Upload
    </div>
    
    <div class="history">
      <div id="historyItems" class="history-items">
        <!-- History items will be added here -->
      </div>
      
      <div id="emptyHistory" class="empty-history">
        Chưa có ảnh nào được upload
      </div>
      
      <div class="clear-history">
        <button id="clearHistoryBtn" class="btn-ghost">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Xóa lịch sử
        </button>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const API_PROXY = "https://imgspace.abuadun4.workers.dev"; // Worker URL
const TOKEN_KEY = "premium-token-789";
const HISTORY_KEY = "imgup-history";
/* ===================== */

// DOM Elements
const apiTokenInput = document.getElementById("apiToken");
const saveTokenBtn = document.getElementById("saveToken");
const preserveCheckbox = document.getElementById("preserve");
const pickFilesBtn = document.getElementById("pickFiles");
const drop = document.getElementById("drop");
const fileInput = document.getElementById("fileInput");
const thumbs = document.getElementById("thumbs");
const uploadBtn = document.getElementById("uploadBtn");
const clearBtn = document.getElementById("clearBtn");
const statusEl = document.getElementById("status");
const urlInput = document.getElementById("urlInput");
const uploadUrlBtn = document.getElementById("uploadUrlBtn");
const historyItemsEl = document.getElementById("historyItems");
const emptyHistoryEl = document.getElementById("emptyHistory");
const clearHistoryBtn = document.getElementById("clearHistoryBtn");

// State
let files = [];
let uploadHistory = [];

// Initialize
apiTokenInput.value = localStorage.getItem(TOKEN_KEY) || "";
loadUploadHistory();
renderUploadHistory();

// Event Listeners
saveTokenBtn.addEventListener("click", () => {
  localStorage.setItem(TOKEN_KEY, apiTokenInput.value.trim());
  showStatus("Token đã lưu", "success");
});

pickFilesBtn.addEventListener("click", () => fileInput.click());
fileInput.addEventListener("change", e => { 
  handleFiles(e.target.files); 
  fileInput.value = ""; 
});

clearBtn.addEventListener("click", () => { 
  files = []; 
  renderThumbs(); 
});

uploadBtn.addEventListener("click", uploadFiles);
uploadUrlBtn.addEventListener("click", uploadFromUrl);
clearHistoryBtn.addEventListener("click", clearHistory);

// Drag and drop
["dragenter", "dragover"].forEach(ev => {
  drop.addEventListener(ev, e => { 
    e.preventDefault(); 
    drop.classList.add("dragover");
  });
});

["dragleave", "drop"].forEach(ev => {
  drop.addEventListener(ev, e => { 
    e.preventDefault(); 
    drop.classList.remove("dragover");
  });
});

drop.addEventListener("drop", e => { 
  e.preventDefault(); 
  handleFiles(e.dataTransfer.files); 
});

// Functions
function bytesToSize(b) { 
  if(b === 0) return '0 B'; 
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB']; 
  const i = Math.floor(Math.log(b) / Math.log(k));
  return parseFloat((b / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]; 
}

function renderThumbs() {
  thumbs.innerHTML = "";
  
  if (files.length === 0) {
    thumbs.innerHTML = '<div class="muted" style="padding:20px;text-align:center;">Chưa có ảnh nào được chọn</div>';
    return;
  }
  
  files.forEach((f, idx) => {
    const el = document.createElement("div");
    el.className = "thumb";
    
    const img = document.createElement("img");
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.readAsDataURL(f.file);
    
    const thumbActions = document.createElement("div");
    thumbActions.className = "thumb-actions";
    
    const removeBtn = document.createElement("button");
    removeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
    removeBtn.onclick = () => { 
      files.splice(idx, 1); 
      renderThumbs(); 
    };
    
    thumbActions.appendChild(removeBtn);
    
    const meta = document.createElement("div");
    meta.className = "thumb-info muted";
    meta.textContent = `${f.file.name} • ${bytesToSize(f.file.size)}`;
    
    const prog = document.createElement("div");
    prog.className = "progress";
    const bar = document.createElement("span");
    bar.className = "progress-bar";
    prog.appendChild(bar);
    
    el.appendChild(thumbActions);
    el.appendChild(img);
    el.appendChild(meta);
    el.appendChild(prog);
    
    thumbs.appendChild(el);
    f._bar = bar;
  });
}

function handleFiles(list) {
  for (const f of list) {
    // Kiểm tra định dạng file
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!validTypes.includes(f.type)) {
      showStatus(`${f.name} không phải là file ảnh hợp lệ. Chỉ chấp nhận JPG, PNG, GIF, WebP.`, "error");
      continue;
    }
    
    if (f.size > 15 * 1024 * 1024) { 
      showStatus(`${f.name} quá lớn (>15MB)`, "error");
      continue; 
    }
    
    files.push({ file: f });
  }
  
  renderThumbs();
}

async function uploadFiles() {
  const token = apiTokenInput.value.trim();
  if (!token) {
    showStatus("Nhập token trước khi upload", "error");
    return;
  }
  
  if (files.length === 0) {
    showStatus("Chưa chọn file", "error");
    return;
  }

  uploadBtn.disabled = true; 
  uploadBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> Đang upload...';
  
  statusEl.style.display = "none";
  
  try {
    const fd = new FormData();
    fd.append("preserveFormat", preserveCheckbox.checked ? "1" : "0");
    
    // Thêm tất cả files vào FormData với key "file" (theo API docs)
    files.forEach(entry => {
      fd.append("file", entry.file);
    });

    // Gửi request upload
    const resp = await fetch(API_PROXY + "/upload", {
      method: "POST",
      headers: { "Authorization": "Bearer " + token },
      body: fd
    });

    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(`HTTP ${resp.status} — ${txt}`);
    }
    
    const data = await resp.json();
    
    // Xử lý kết quả
    if (data && data.success) {
      if (data.results && data.results.length > 0) {
        // Lưu vào lịch sử
        data.results.forEach(result => {
          addToUploadHistory(result);
        });
        
        showStatus(`Upload thành công ${data.results.length} ảnh`, "success");
        
        // Xóa files đã upload
        files = [];
        renderThumbs();
      }
      
      // Xử lý lỗi nếu có
      if (data.errors && data.errors.length > 0) {
        data.errors.forEach(err => {
          showStatus(`${err.filename || "Unknown file"}: ${err.error || "Processing failed"}`, "error");
        });
      }
    } else {
      throw new Error("Upload không thành công: " + JSON.stringify(data));
    }
  } catch (err) {
    showStatus("Upload thất bại: " + err.message, "error");
    console.error("Upload error:", err);
  }

  uploadBtn.disabled = false; 
  uploadBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg> Upload file(s)';
}

async function uploadFromUrl() {
  const token = apiTokenInput.value.trim();
  const url = urlInput.value.trim();
  
  if (!token) {
    showStatus("Nhập token trước", "error");
    return;
  }
  
  if (!url) {
    showStatus("Nhập URL", "error");
    return;
  }

  uploadUrlBtn.disabled = true; 
  uploadUrlBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> Đang upload...';
  
  try {
    const body = { 
      urls: [url], 
      preserveFormat: preserveCheckbox.checked ? 1 : 0 
    };
    
    const resp = await fetch(API_PROXY + "/url", {
      method: "POST",
      headers: { 
        "Authorization": "Bearer " + token, 
        "Content-Type": "application/json" 
      },
      body: JSON.stringify(body)
    });
    
    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(`HTTP ${resp.status} — ${txt}`);
    }
    
    const data = await resp.json();
    
    if (data && data.results) {
      // Lưu vào lịch sử
      data.results.forEach(result => {
        addToUploadHistory(result);
      });
      
      showStatus("Upload từ URL thành công", "success");
      urlInput.value = "";
    } else {
      throw new Error("Upload không thành công: " + JSON.stringify(data));
    }
  } catch (err) {
    showStatus("Upload từ URL thất bại: " + err.message, "error");
    console.error("URL upload error:", err);
  }
  
  uploadUrlBtn.disabled = false; 
  uploadUrlBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg> Upload';
}

function addToUploadHistory(item) {
  // Load history từ localStorage
  const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
  
  // Thêm item mới vào đầu mảng
  history.unshift({
    id: item.id,
    filename: item.filename,
    url: item.url,
    size: item.size,
    format: item.format,
    uploadedAt: item.uploadedAt || new Date().toISOString()
  });
  
  // Giới hạn lịch sử (tối đa 50 items)
  if (history.length > 50) {
    history.pop();
  }
  
  // Lưu lại vào localStorage
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  
  // Render lại lịch sử
  renderUploadHistory();
}

function loadUploadHistory() {
  uploadHistory = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
}

function renderUploadHistory() {
  historyItemsEl.innerHTML = "";
  
  if (uploadHistory.length === 0) {
    emptyHistoryEl.style.display = "block";
    return;
  }
  
  emptyHistoryEl.style.display = "none";
  
  uploadHistory.forEach(item => {
    const historyItem = document.createElement("div");
    historyItem.className = "history-item";
    
    const img = document.createElement("img");
    img.src = item.url;
    img.alt = item.filename;
    img.className = "history-image";
    
    const info = document.createElement("div");
    info.className = "history-info";
    
    const name = document.createElement("div");
    name.textContent = item.filename;
    name.style.fontWeight = "600";
    name.style.marginBottom = "4px";
    
    const meta = document.createElement("div");
    meta.className = "muted";
    meta.textContent = `${bytesToSize(item.size?.processed || 0)} • ${item.format?.processed || "unknown"}`;
    
    info.appendChild(name);
    info.appendChild(meta);
    
    const urlContainer = document.createElement("div");
    urlContainer.className = "history-url";
    
    const urlInput = document.createElement("input");
    urlInput.value = item.url;
    urlInput.readOnly = true;
    urlInput.onclick = () => urlInput.select();
    
    const copyBtn = document.createElement("button");
    copyBtn.className = "btn";
    copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>';
    copyBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(item.url);
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
        setTimeout(() => {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>';
        }, 2000);
      } catch (err) {
        console.error("Copy failed:", err);
      }
    };
    
    urlContainer.appendChild(urlInput);
    urlContainer.appendChild(copyBtn);
    
    const actions = document.createElement("div");
    actions.className = "history-actions";
    
    const openBtn = document.createElement("button");
    openBtn.className = "btn-ghost";
    openBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg> Mở';
    openBtn.onclick = () => window.open(item.url, "_blank");
    
    const deleteBtn = document.createElement("button");
    deleteBtn.className = "btn-ghost";
    deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg> Xóa';
    deleteBtn.onclick = () => removeFromHistory(item.id);
    
    actions.appendChild(openBtn);
    actions.appendChild(deleteBtn);
    
    historyItem.appendChild(img);
    historyItem.appendChild(info);
    historyItem.appendChild(urlContainer);
    historyItem.appendChild(actions);
    
    historyItemsEl.appendChild(historyItem);
  });
}

function removeFromHistory(id) {
  uploadHistory = uploadHistory.filter(item => item.id !== id);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(uploadHistory));
  renderUploadHistory();
}

function clearHistory() {
  if (confirm("Bạn có chắc muốn xóa toàn bộ lịch sử upload?")) {
    localStorage.removeItem(HISTORY_KEY);
    uploadHistory = [];
    renderUploadHistory();
  }
}

function showStatus(message, type) {
  statusEl.textContent = message;
  statusEl.className = "status " + type;
  statusEl.style.display = "block";
  
  // Tự động ẩn thông báo sau 5 giây
  if (type === "success") {
    setTimeout(() => {
      statusEl.style.display = "none";
    }, 5000);
  }
}

// Initial render
renderThumbs();
</script>
</body>
</html>
