<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>imgUP — Upload (via Worker)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4}
    body{background:linear-gradient(180deg,#071024,#081426);color:#e6eef6;font-family:Inter,Arial,Helvetica,sans-serif;padding:20px;display:flex;justify-content:center}
    .card{width:100%;max-width:980px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    h1{margin:0 0 8px 0}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input[type="text"]{padding:8px;border-radius:8px;border:1px dashed rgba(255,255,255,0.06);background:transparent;color:inherit}
    button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn{background:var(--accent);color:#052024;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .drop{border:2px dashed rgba(255,255,255,0.04);padding:24px;border-radius:10px;text-align:center;cursor:pointer}
    .thumbs{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .thumb{width:140px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
    .thumb img{width:100%;height:96px;object-fit:cover;border-radius:6px}
    .progress{height:6px;background:rgba(255,255,255,0.04);border-radius:99px;margin-top:6px;overflow:hidden}
    .progress i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#8b5cf6)}
    .results{margin-top:14px}
    .result{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .input-small{padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .muted{color:var(--muted)}
    @media(max-width:640px){.controls{flex-direction:column;align-items:stretch}}
  </style>
</head>
<body>
  <div class="card">
    <h1>imgUP — Upload</h1>
    <div class="controls">
      <input id="apiToken" type="text" placeholder="Bearer token" style="min-width:320px" />
      <button id="saveToken" class="btn-ghost">Lưu</button>
      <label class="muted" style="margin-left:auto"><input id="preserve" type="checkbox" /> Giữ định dạng</label>
      <button id="pickFiles" class="btn">Chọn ảnh</button>
    </div>

    <div id="drop" class="drop">
      <div style="font-weight:600">Kéo & thả ảnh vào đây</div>
      <div class="muted">Hỗ trợ JPG, PNG, GIF, WebP — Tối đa 15MB</div>
    </div>

    <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
    <div id="thumbs" class="thumbs"></div>

    <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
      <button id="uploadBtn" class="btn">Upload file(s)</button>
      <button id="clearBtn" class="btn-ghost">Xóa</button>
      <div style="margin-left:auto" class="muted">Worker: <code id="workerUrl">-</code></div>
    </div>

    <hr style="margin:14px 0">

    <h3>Upload từ URL</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="urlInput" type="text" placeholder="https://example.com/image.jpg" style="flex:1;padding:8px;border-radius:8px;border:1px dashed rgba(255,255,255,0.06);background:transparent;color:inherit" />
      <button id="uploadUrlBtn" class="btn">Upload</button>
    </div>

    <hr style="margin:14px 0">

    <h3>Lấy link ảnh (id)</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="idInput" type="text" placeholder="image id (ví dụ: 1703123456789-abc123)" style="flex:1;padding:8px;border-radius:8px;border:1px dashed rgba(255,255,255,0.06);background:transparent;color:inherit" />
      <button id="getLinkBtn" class="btn">Get Link</button>
    </div>

    <div id="results" class="results"></div>
  </div>

<script>
/* ====== CONFIG ====== */
const API_PROXY = "https://imgspace.abuadun4.workers.dev/"; // <-- THAY bằng Worker URL (no trailing slash)
const TOKEN_KEY = "premium-token-789";
/* ===================== */

document.getElementById("workerUrl").textContent = API_PROXY;

const apiTokenInput = document.getElementById("apiToken");
const saveTokenBtn = document.getElementById("saveToken");
const preserveCheckbox = document.getElementById("preserve");
const pickFilesBtn = document.getElementById("pickFiles");
const drop = document.getElementById("drop");
const fileInput = document.getElementById("fileInput");
const thumbs = document.getElementById("thumbs");
const uploadBtn = document.getElementById("uploadBtn");
const clearBtn = document.getElementById("clearBtn");
const results = document.getElementById("results");
const urlInput = document.getElementById("urlInput");
const uploadUrlBtn = document.getElementById("uploadUrlBtn");
const idInput = document.getElementById("idInput");
const getLinkBtn = document.getElementById("getLinkBtn");

apiTokenInput.value = localStorage.getItem(TOKEN_KEY) || "";
saveTokenBtn.addEventListener("click", () => {
  localStorage.setItem(TOKEN_KEY, apiTokenInput.value.trim());
  alert("Token đã lưu");
});

let files = [];
function bytesToSize(b){ if(b===0) return '0 B'; const k=1024,s=['B','KB','MB','GB']; const i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+s[i]; }
function renderThumbs(){
  thumbs.innerHTML = "";
  files.forEach((f, idx) => {
    const el = document.createElement("div");
    el.className = "thumb";
    const img = document.createElement("img");
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.readAsDataURL(f.file);
    const meta = document.createElement("div");
    meta.className = "muted";
    meta.textContent = `${f.file.name} • ${bytesToSize(f.file.size)}`;
    const prog = document.createElement("div");
    prog.className = "progress";
    const bar = document.createElement("i");
    prog.appendChild(bar);
    const removeBtn = document.createElement("button");
    removeBtn.className = "btn-ghost";
    removeBtn.style.marginTop = "6px";
    removeBtn.textContent = "Xóa";
    removeBtn.onclick = () => { files.splice(idx,1); renderThumbs(); };
    el.appendChild(img);
    el.appendChild(meta);
    el.appendChild(prog);
    el.appendChild(removeBtn);
    thumbs.appendChild(el);
    f._bar = bar;
  });
}

pickFilesBtn.addEventListener("click", ()=> fileInput.click());
fileInput.addEventListener("change", e => { handleFiles(e.target.files); fileInput.value = ""; });
function handleFiles(list){
  for (const f of list){
    if (!f.type.startsWith("image/")) continue;
    if (f.size > 15 * 1024 * 1024) { alert(`${f.name} quá lớn (>15MB)`); continue; }
    files.push({ file: f });
  }
  renderThumbs();
}
["dragenter","dragover"].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); drop.style.borderColor = "#06b6d4"; }));
["dragleave","drop"].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); drop.style.borderColor = ""; }));
drop.addEventListener("drop", e => { e.preventDefault(); handleFiles(e.dataTransfer.files); });

clearBtn.addEventListener("click", ()=>{ files = []; renderThumbs(); results.innerHTML = ""; });

/* ---- Upload files ---- */
uploadBtn.addEventListener("click", async () => {
  const token = apiTokenInput.value.trim();
  if (!token) return alert("Nhập token trước");
  if (files.length === 0) return alert("Chưa chọn file");

  uploadBtn.disabled = true; uploadBtn.textContent = "Đang upload...";
  results.innerHTML = "";

  for (const entry of files) {
    try {
      const fd = new FormData();
      fd.append("preserveFormat", preserveCheckbox.checked ? "1" : "0");
      fd.append("file", entry.file); // per docs: key = "file"

      // send to Worker /upload
      const resp = await fetch(API_PROXY + "/upload", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: fd
      });

      if (!resp.ok) {
        const txt = await resp.text();
        appendError(entry.file.name, `HTTP ${resp.status} — ${txt}`);
      } else {
        const data = await resp.json();
        if (data && data.results) data.results.forEach(r => appendResult(r));
        else appendError(entry.file.name, JSON.stringify(data));
      }
    } catch (err) {
      appendError(entry.file.name, err.message || err);
    }
  }

  uploadBtn.disabled = false; uploadBtn.textContent = "Upload file(s)";
});

/* ---- Upload from URL ---- */
uploadUrlBtn.addEventListener("click", async () => {
  const token = apiTokenInput.value.trim();
  const url = urlInput.value.trim();
  if (!token) return alert("Nhập token trước");
  if (!url) return alert("Nhập URL");

  uploadUrlBtn.disabled = true; uploadUrlBtn.textContent = "Đang upload...";
  try {
    const body = { urls: [url], preserveFormat: preserveCheckbox.checked ? 1 : 0 };
    const resp = await fetch(API_PROXY + "/url", {
      method: "POST",
      headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if (!resp.ok) {
      const txt = await resp.text();
      appendError(url, `HTTP ${resp.status} — ${txt}`);
    } else {
      const data = await resp.json();
      if (data && data.results) data.results.forEach(r => appendResult(r));
      else appendError(url, JSON.stringify(data));
    }
  } catch (err) {
    appendError(url, err.message || err);
  }
  uploadUrlBtn.disabled = false; uploadUrlBtn.textContent = "Upload";
});

/* ---- Get link by id ---- */
getLinkBtn.addEventListener("click", async () => {
  const token = apiTokenInput.value.trim();
  const id = idInput.value.trim();
  if (!token) return alert("Nhập token trước");
  if (!id) return alert("Nhập image id");

  getLinkBtn.disabled = true; getLinkBtn.textContent = "Đang lấy...";
  try {
    const resp = await fetch(API_PROXY + "/link?id=" + encodeURIComponent(id), {
      method: "GET",
      headers: { "Authorization": "Bearer " + token }
    });
    if (!resp.ok) {
      const txt = await resp.text();
      appendError(id, `HTTP ${resp.status} — ${txt}`);
    } else {
      const data = await resp.json();
      if (data && data.url) appendResult(data);
      else appendError(id, JSON.stringify(data));
    }
  } catch (err) {
    appendError(id, err.message || err);
  }
  getLinkBtn.disabled = false; getLinkBtn.textContent = "Get Link";
});

/* ---- UI helpers ---- */
function appendResult(r){
  const el = document.createElement("div");
  el.className = "result";
  const left = document.createElement("div");
  left.style.display = "flex"; left.style.gap = "10px"; left.style.alignItems = "center";
  if (r.url) {
    const thumb = document.createElement("img");
    thumb.src = r.url;
    thumb.style.width = "96px"; thumb.style.height = "64px"; thumb.style.objectFit = "cover"; thumb.style.borderRadius = "6px";
    left.appendChild(thumb);
  }
  const info = document.createElement("div");
  const name = document.createElement("div"); name.textContent = r.filename || r.sourceUrl || r.id || "(image)";
  name.style.fontWeight = "600";
  const meta = document.createElement("div"); meta.className = "muted";
  if (r.size && r.size.processed) meta.textContent = `${bytesToSize(r.size.processed)} • ${r.format ? r.format.processed : ""}`;
  info.appendChild(name); info.appendChild(meta);
  left.appendChild(info);

  const right = document.createElement("div"); right.style.display="flex"; right.style.gap="8px"; right.style.alignItems="center";
  const linkInput = document.createElement("input"); linkInput.className="input-small"; linkInput.value = r.url || ""; linkInput.readOnly=true; linkInput.onclick = ()=> linkInput.select();
  const copyBtn = document.createElement("button"); copyBtn.className="btn"; copyBtn.textContent="Copy"; copyBtn.onclick = async ()=> { await navigator.clipboard.writeText(r.url||""); copyBtn.textContent="Copied"; setTimeout(()=>copyBtn.textContent="Copy",1500); };
  const openBtn = document.createElement("button"); openBtn.className="btn-ghost"; openBtn.textContent="Open"; openBtn.onclick = ()=> window.open(r.url,"_blank");
  right.appendChild(linkInput); right.appendChild(copyBtn); right.appendChild(openBtn);

  el.appendChild(left); el.appendChild(right);
  results.appendChild(el);
}
function appendError(name, err){
  const el = document.createElement("div"); el.className="result"; el.innerHTML = `<div style="color:#ffb4b4;font-weight:600">${name}</div><div class="muted">${err}</div>`;
  results.appendChild(el);
}
</script>
</body>
</html>
